# cloud-config

write_files:
  - path: /etc/systemd/system/aiinfra_pull_image.sh
    permissions: 0755
    owner: root
    content: |
      #!/bin/sh
      docker_image='${docker_image}'
      docker pull $${docker_image}
  - path: /etc/systemd/system/aiinfra-pull-image.service
    permissions: 0644
    owner: root
    content: |
      [Unit]
      After=gcr-online.target docker.socket
      Description=Pull a docker image
      Wants=gcr-online.target docker.socket
      [Service]
      ExecStart=/etc/systemd/system/aiinfra_pull_image.sh
      RemainAfterExit=true
      StandardOutput=journal+console
      StandardError=journal+console
      Type=oneshot
      User=root
  - path: /etc/systemd/system/aiinfra_start_container.sh
    permissions: 0755
    owner: root
    content: |
      #!/bin/sh
      docker_cmd='${docker_cmd}'
      docker_image='${docker_image}'
      docker_volume_flags='${docker_volume_flags}'
      host_mountpoints='${host_mountpoints}'
      [ -z "$${host_mountpoints}" ] || mkdir -p $${host_mountpoints}
      mount -a && docker run \
        --rm \
        --name aiinfra \
        $${docker_volume_flags} \
        $${docker_image} $${docker_cmd}
  - path: /etc/systemd/system/aiinfra-start-container.service
    permissions: 0644
    owner: root
    content: |
      [Unit]
      After=aiinfra-pull-image.service
      Description=Run a docker container
      Requires=aiinfra-pull-image.service
      [Service]
      ExecStart=/etc/systemd/system/aiinfra_start_container.sh
      RemainAfterExit=true
      StandardError=journal+console
      StandardOutput=journal+console
      Type=oneshot
      User=root

mounts: ${fstab_lines}

runcmd:
  - systemctl daemon-reload
  - systemctl start aiinfra-pull-image aiinfra-start-container
